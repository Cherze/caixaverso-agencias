<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ag√™ncias Banc√°rias - Quarkus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { margin-bottom: 20px; }
        .table-responsive { max-height: 500px; overflow-y: auto; }
        .btn-action { margin: 2px; }
        .address-fields { background-color: #f8f9fa; padding: 15px; border-radius: 5px; }
        .search-panel { background-color: #e9ecef; padding: 15px; border-radius: 5px; }
        .header-buttons { display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="text-center">üè¶ Sistema de Ag√™ncias Banc√°rias</h1>
            <p class="text-center text-muted">API REST desenvolvida com Quarkus</p>
        </div>
    </div>

    <!-- Alertas -->
    <div id="alertContainer"></div>

    <div class="row">
        <!-- Lista de Ag√™ncias -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìã Lista de Ag√™ncias</h5>
                    <div class="header-buttons">
                        <button class="btn btn-sm btn-outline-primary" onclick="loadAgencias()">
                            üîÑ Atualizar
                        </button>
                        <button class="btn btn-sm btn-success" onclick="exportToExcel()">
                            üìä Exportar Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                            <tr>
                                <th>CGC</th>
                                <th>Nome</th>
                                <th>Gestor</th>
                                <th>CEP</th>
                                <th>Logradouro</th>
                                <th>Cidade</th>
                                <th>Estado</th>
                                <th>N√∫mero</th>
                                <th>Data Inaugura√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                            </thead>
                            <tbody id="agenciasTableBody">
                            <tr>
                                <td colspan="10" class="text-center">
                                    Carregando ag√™ncias...
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Buscas -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">üîç Buscar Ag√™ncias</h5>
                </div>
                <div class="card-body search-panel">
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Tipo de Busca:</label>
                            <select id="searchType" class="form-select" onchange="updateSearchPlaceholder()">
                                <option value="cgc">Por CGC</option>
                                <option value="cidade">Por Cidade</option>
                                <option value="estado">Por Estado</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Termo de Busca:</label>
                            <div class="input-group">
                                <input type="text" id="searchTerm" class="form-control"
                                       placeholder="Digite o CGC..." onkeypress="handleSearchKeyPress(event)">
                                <button class="btn btn-primary" onclick="performSearch()">
                                    üîç Buscar
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2 mb-2 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" onclick="loadAgencias()">
                                üóëÔ∏è Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formul√°rio de Cadastro -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">‚ûï Nova Ag√™ncia</h5>
                </div>
                <div class="card-body">
                    <form id="agenciaForm">
                        <div class="mb-2">
                            <label for="cgc" class="form-label">CGC *</label>
                            <input type="text" id="cgc" class="form-control"
                                   maxlength="4" required placeholder="4 d√≠gitos (ex: 0001)"
                                   oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            <div class="form-text">N√∫mero de 4 d√≠gitos</div>
                        </div>

                        <div class="mb-2">
                            <label for="nome_agencia" class="form-label">Nome da Ag√™ncia *</label>
                            <input type="text" id="nome_agencia" class="form-control" required
                                   placeholder="Ex: Ag√™ncia Centro">
                        </div>

                        <div class="mb-2">
                            <label for="nome_gestor" class="form-label">Gestor *</label>
                            <input type="text" id="nome_gestor" class="form-control" required
                                   placeholder="Ex: Jo√£o Silva">
                        </div>

                        <!-- Campos de Endere√ßo -->
                        <div class="address-fields mb-3">
                            <h6 class="mb-3">üìç Endere√ßo</h6>

                            <div class="mb-2">
                                <label for="cep" class="form-label">CEP *</label>
                                <input type="text" id="cep" class="form-control"
                                       maxlength="10" required
                                       placeholder="00000-000"
                                       oninput="formatCEP(this)"
                                       onblur="buscarEnderecoPorCEP()">
                                <div class="form-text">Digite o CEP com 8 d√≠gitos</div>
                            </div>

                            <div class="mb-2">
                                <label for="numero" class="form-label">N√∫mero *</label>
                                <input type="number" id="numero" class="form-control"
                                       min="1" max="99999" required
                                       placeholder="Ex: 123">
                                <div class="form-text">N√∫mero do endere√ßo</div>
                            </div>

                            <!-- Campos apenas para exibi√ß√£o (preenchidos automaticamente) -->
                            <div class="mb-2">
                                <label class="form-label">Logradouro</label>
                                <input type="text" id="logradouro_display" class="form-control" readonly>
                            </div>

                            <div class="row">
                                <div class="col-md-8 mb-2">
                                    <label class="form-label">Cidade</label>
                                    <input type="text" id="cidade_display" class="form-control" readonly>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <label class="form-label">Estado</label>
                                    <input type="text" id="estado_display" class="form-control" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="data_inauguracao" class="form-label">Data de Inaugura√ß√£o *</label>
                            <input type="date" id="data_inauguracao" class="form-control" required>
                        </div>

                        <button type="submit" class="btn btn-success w-100">
                            üíæ Cadastrar Ag√™ncia
                        </button>
                    </form>
                </div>
            </div>

            <!-- Informa√ß√µes da API -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">‚ÑπÔ∏è Informa√ß√µes</h5>
                </div>
                <div class="card-body">
                    <p><strong>URL da API:</strong> <code>/agencias</code></p>
                    <p><strong>Documenta√ß√£o:</strong>
                        <a href="/q/swagger-ui" target="_blank" class="btn btn-sm btn-outline-info">
                            Swagger UI
                        </a>
                    </p>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Edi√ß√£o -->
<div class="modal fade" id="edicaoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Ag√™ncia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edicaoForm">
                    <input type="hidden" id="edit_cgc">

                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="edit_nome_agencia" class="form-label">Nome da Ag√™ncia *</label>
                            <input type="text" id="edit_nome_agencia" class="form-control" required>
                        </div>

                        <div class="col-md-6 mb-2">
                            <label for="edit_nome_gestor" class="form-label">Gestor *</label>
                            <input type="text" id="edit_nome_gestor" class="form-control" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="edit_cep" class="form-label">CEP *</label>
                            <input type="text" id="edit_cep" class="form-control"
                                   maxlength="10" required
                                   oninput="formatCEP(this)"
                                   onblur="buscarEnderecoEdicao()">
                            <div class="form-text">Digite o CEP com 8 d√≠gitos</div>
                        </div>

                        <div class="col-md-6 mb-2">
                            <label for="edit_numero" class="form-label">N√∫mero *</label>
                            <input type="number" id="edit_numero" class="form-control"
                                   min="1" max="99999" required>
                        </div>
                    </div>

                    <!-- Campos apenas para exibi√ß√£o -->
                    <div class="mb-2">
                        <label class="form-label">Logradouro</label>
                        <input type="text" id="edit_logradouro_display" class="form-control" readonly>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-2">
                            <label class="form-label">Cidade</label>
                            <input type="text" id="edit_cidade_display" class="form-control" readonly>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Estado</label>
                            <input type="text" id="edit_estado_display" class="form-control" readonly>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit_data_inauguracao" class="form-label">Data de Inaugura√ß√£o *</label>
                        <input type="date" id="edit_data_inauguracao" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarEdicao()">üíæ Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Vari√°veis globais
    const BASE_URL = 'http://localhost:8080';
    let agenciasData = [];

    // Fun√ß√£o para exportar para Excel
    async function exportToExcel() {
        try {
            showAlert('Gerando arquivo Excel...', 'info');

            const response = await fetch(`${BASE_URL}/agencias/export/excel`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('admin:admin')
                }
            });

            if (!response.ok) {
                throw new Error(`Erro ao exportar: ${response.status} ${response.statusText}`);
            }

            // Converter a resposta para blob
            const blob = await response.blob();

            // Criar link para download
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'agencias.xlsx';

            // Adicionar ao documento e clicar
            document.body.appendChild(a);
            a.click();

            // Limpar
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showAlert('Arquivo Excel gerado com sucesso!', 'success');

        } catch (error) {
            console.error('Erro ao exportar para Excel:', error);
            showAlert('Erro ao exportar para Excel: ' + error.message, 'danger');
        }
    }

    // Fun√ß√£o para formatar CEP para exibi√ß√£o
    function formatCEPDisplay(cep) {
        if (!cep) return 'N/A';
        const cleanCEP = cep.replace(/\D/g, '');
        if (cleanCEP.length === 8) {
            return cleanCEP.replace(/^(\d{5})(\d{3})$/, '$1-$2');
        }
        return cep;
    }

    // Fun√ß√£o para corrigir o problema do fuso hor√°rio da data
    function formatarDataBrasileira(dataString) {
        if (!dataString) return 'N/A';

        // Corrige o problema do fuso hor√°rio adicionando o timezone
        const data = new Date(dataString + 'T00:00:00-03:00');

        if (isNaN(data.getTime())) {
            return 'Data inv√°lida';
        }

        return data.toLocaleDateString('pt-BR');
    }

    // Fun√ß√£o para buscar endere√ßo via ViaCEP
    async function buscarEnderecoPorCEP() {
        const cepInput = document.getElementById('cep');
        const cep = cepInput.value.replace(/\D/g, '');

        if (cep.length !== 8) {
            showAlert('CEP deve conter 8 d√≠gitos', 'warning');
            return;
        }

        try {
            showAlert('Buscando endere√ßo...', 'info');
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const endereco = await response.json();

            if (!endereco.erro) {
                document.getElementById('logradouro_display').value = endereco.logradouro || '';
                document.getElementById('cidade_display').value = endereco.localidade || '';
                document.getElementById('estado_display').value = endereco.uf || '';
                showAlert('Endere√ßo encontrado!', 'success');
            } else {
                showAlert('CEP n√£o encontrado', 'warning');
                document.getElementById('logradouro_display').value = '';
                document.getElementById('cidade_display').value = '';
                document.getElementById('estado_display').value = '';
            }
        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
            showAlert('Erro ao consultar o CEP', 'danger');
        }
    }

    // Fun√ß√£o para buscar endere√ßo na edi√ß√£o
    async function buscarEnderecoEdicao() {
        const cepInput = document.getElementById('edit_cep');
        const cep = cepInput.value.replace(/\D/g, '');

        if (cep.length !== 8) {
            showAlert('CEP deve conter 8 d√≠gitos', 'warning');
            return;
        }

        try {
            showAlert('Buscando endere√ßo...', 'info');
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const endereco = await response.json();

            if (!endereco.erro) {
                document.getElementById('edit_logradouro_display').value = endereco.logradouro || '';
                document.getElementById('edit_cidade_display').value = endereco.localidade || '';
                document.getElementById('edit_estado_display').value = endereco.uf || '';
                showAlert('Endere√ßo encontrado!', 'success');
            } else {
                showAlert('CEP n√£o encontrado', 'warning');
                document.getElementById('edit_logradouro_display').value = '';
                document.getElementById('edit_cidade_display').value = '';
                document.getElementById('edit_estado_display').value = '';
            }
        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
            showAlert('Erro ao consultar o CEP', 'danger');
        }
    }

    // Fun√ß√£o para formatar CEP
    function formatCEP(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 8) value = value.slice(0, 8);
        if (value.length > 5) value = value.replace(/^(\d{5})(\d{0,3})/, '$1-$2');
        input.value = value;
    }

    // Fun√ß√£o para validar CEP
    function validateCEP(cep) {
        const cleanCEP = cep.replace(/\D/g, '');
        return cleanCEP.length === 8;
    }

    // Atualizar placeholder da busca
    function updateSearchPlaceholder() {
        const searchType = document.getElementById('searchType').value;
        const searchTerm = document.getElementById('searchTerm');

        switch(searchType) {
            case 'cgc':
                searchTerm.placeholder = 'Digite o CGC (4 d√≠gitos)...';
                break;
            case 'cidade':
                searchTerm.placeholder = 'Digite o nome da cidade...';
                break;
            case 'estado':
                searchTerm.placeholder = 'Digite a sigla do estado (ex: BA)...';
                break;
        }
    }

    // Buscar com Enter
    function handleSearchKeyPress(event) {
        if (event.key === 'Enter') performSearch();
    }

    // Executar busca
    async function performSearch() {
        const searchType = document.getElementById('searchType').value;
        const searchTerm = document.getElementById('searchTerm').value.trim();

        if (!searchTerm) {
            showAlert('Digite um termo para buscar', 'warning');
            return;
        }

        try {
            showLoading(true);
            let url;

            switch(searchType) {
                case 'cgc':
                    try {
                        const response = await fetch(`${BASE_URL}/agencias/cgc/${searchTerm}`);
                        if (response.ok) {
                            const agencia = await response.json();
                            renderAgenciasTable([agencia]);
                            showAlert(`Ag√™ncia ${searchTerm} encontrada!`);
                        } else {
                            showAlert('Ag√™ncia n√£o encontrada', 'warning');
                            renderAgenciasTable([]);
                        }
                    } catch (error) {
                        showAlert('Erro na busca por CGC', 'danger');
                    }
                    break;

                case 'cidade':
                    url = `${BASE_URL}/agencias/filtro/cidade/${encodeURIComponent(searchTerm)}`;
                    await fetchAndRenderSearch(url, `cidade "${searchTerm}"`);
                    break;

                case 'estado':
                    url = `${BASE_URL}/agencias/filtro/estado/${encodeURIComponent(searchTerm.toUpperCase())}`;
                    await fetchAndRenderSearch(url, `estado ${searchTerm}`);
                    break;
            }
        } catch (error) {
            showAlert('Erro na busca', 'danger');
        } finally {
            showLoading(false);
        }
    }

    // Fun√ß√£o auxiliar para busca e renderiza√ß√£o
    async function fetchAndRenderSearch(url, searchDescription) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Erro na busca');

            const agencias = await response.json();
            renderAgenciasTable(agencias);

            if (agencias.length === 0) {
                showAlert(`Nenhuma ag√™ncia encontrada para ${searchDescription}`, 'warning');
            } else {
                showAlert(`${agencias.length} ag√™ncia(s) encontrada(s) para ${searchDescription}`, 'success');
            }
        } catch (error) {
            showAlert(`Erro ao buscar por ${searchDescription}`, 'danger');
        }
    }

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
        loadAgencias();
        setupEventListeners();
        updateSearchPlaceholder();
    });

    function setupEventListeners() {
        document.getElementById('agenciaForm').addEventListener('submit', handleFormSubmit);
    }

    // Fun√ß√£o para mostrar alertas
    function showAlert(message, type = 'success') {
        const alertContainer = document.getElementById('alertContainer');
        const alertId = 'alert-' + Date.now();

        const alertHTML = `
            <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        alertContainer.innerHTML = alertHTML;

        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) alert.remove();
        }, 5000);
    }

    // Carregar ag√™ncias
    async function loadAgencias() {
        try {
            showLoading(true);
            const response = await fetch(`${BASE_URL}/agencias`);

            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);

            agenciasData = await response.json();
            renderAgenciasTable(agenciasData);
            showAlert(`${agenciasData.length} ag√™ncias carregadas com sucesso!`);

        } catch (error) {
            console.error('Erro ao carregar ag√™ncias:', error);
            showAlert('Erro ao carregar ag√™ncias. Verifique se a API est√° rodando.', 'danger');
        } finally {
            showLoading(false);
        }
    }

    // Renderizar tabela
    function renderAgenciasTable(agencias) {
        const tbody = document.getElementById('agenciasTableBody');

        if (agencias.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center text-muted">
                        Nenhuma ag√™ncia encontrada.
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = agencias.map(agencia => `
            <tr>
                <td><strong>${agencia.cgc}</strong></td>
                <td>${agencia.nome_agencia}</td>
                <td>${agencia.nome_gestor}</td>
                <td>${formatCEPDisplay(agencia.cep)}</td>
                <td>${agencia.logradouro || 'N/A'}</td>
                <td>${agencia.cidade || 'N/A'}</td>
                <td>${agencia.estado || 'N/A'}</td>
                <td>${agencia.numero || 'N/A'}</td>
                <td>${formatarDataBrasileira(agencia.data_inauguracao)}</td>
                <td>
                    <button class="btn btn-sm btn-info btn-action"
                            onclick="editarAgencia('${agencia.cgc}')" title="Editar">
                        ‚úèÔ∏è
                    </button>
                    <button class="btn btn-sm btn-danger btn-action"
                            onclick="deleteAgencia('${agencia.cgc}')" title="Excluir">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Abrir modal de edi√ß√£o
    async function editarAgencia(cgc) {
        try {
            const response = await fetch(`${BASE_URL}/agencias/cgc/${cgc}`);
            if (!response.ok) throw new Error('Ag√™ncia n√£o encontrada');

            const agencia = await response.json();

            // Preencher formul√°rio de edi√ß√£o
            document.getElementById('edit_cgc').value = agencia.cgc;
            document.getElementById('edit_nome_agencia').value = agencia.nome_agencia;
            document.getElementById('edit_nome_gestor').value = agencia.nome_gestor;
            document.getElementById('edit_cep').value = formatCEPDisplay(agencia.cep);
            document.getElementById('edit_numero').value = agencia.numero;
            document.getElementById('edit_data_inauguracao').value = agencia.data_inauguracao;

            // Preencher campos de exibi√ß√£o
            document.getElementById('edit_logradouro_display').value = agencia.logradouro || '';
            document.getElementById('edit_cidade_display').value = agencia.cidade || '';
            document.getElementById('edit_estado_display').value = agencia.estado || '';

            // Abrir modal
            new bootstrap.Modal(document.getElementById('edicaoModal')).show();

        } catch (error) {
            showAlert('Erro ao carregar dados para edi√ß√£o', 'danger');
        }
    }

    // Salvar edi√ß√£o
    async function salvarEdicao() {
        const cgc = parseInt(document.getElementById('edit_cgc').value);

        // Valida√ß√£o do CEP
        const cepInput = document.getElementById('edit_cep');
        if (!validateCEP(cepInput.value)) {
            showAlert('CEP inv√°lido. Digite um CEP com 8 d√≠gitos.', 'danger');
            cepInput.focus();
            return;
        }

        const dadosAtualizacao = {
            nome_agencia: document.getElementById('edit_nome_agencia').value,
            nome_gestor: document.getElementById('edit_nome_gestor').value,
            cep: document.getElementById('edit_cep').value.replace(/\D/g, ''),
            numero: parseInt(document.getElementById('edit_numero').value),
            data_inauguracao: document.getElementById('edit_data_inauguracao').value
        };

        console.log('Enviando dados para edi√ß√£o:', dadosAtualizacao);

        try {
            // Tente primeiro PUT no endpoint correto
            let response = await fetch(`${BASE_URL}/agencias/${cgc}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa('admin:admin')
                },
                body: JSON.stringify(dadosAtualizacao)
            });

            console.log('Resposta do PUT:', response.status, response.statusText);

            // Se PUT n√£o funcionar, tente PATCH
            if (!response.ok) {
                console.log('PUT falhou, tentando PATCH...');
                response = await fetch(`${BASE_URL}/agencias/${cgc}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + btoa('admin:admin')
                    },
                    body: JSON.stringify(dadosAtualizacao)
                });
                console.log('Resposta do PATCH:', response.status, response.statusText);
            }

            if (response.ok) {
                showAlert('Ag√™ncia atualizada com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('edicaoModal')).hide();
                loadAgencias();
            } else {
                const errorText = await response.text();
                console.error('Erro detalhado do servidor:', errorText);
                showAlert(`Erro ${response.status}: ${errorText}`, 'danger');
            }
        } catch (error) {
            console.error('Erro de conex√£o:', error);
            showAlert('Erro de conex√£o com a API: ' + error.message, 'danger');
        }
    }

    // Manipular envio do formul√°rio de cria√ß√£o
    async function handleFormSubmit(e) {
        e.preventDefault();

        // Valida√ß√£o do CEP
        const cepInput = document.getElementById('cep');
        if (!validateCEP(cepInput.value)) {
            showAlert('CEP inv√°lido. Digite um CEP com 8 d√≠gitos.', 'danger');
            cepInput.focus();
            return;
        }

        const agencia = {
            cgc: document.getElementById('cgc').value,
            nome_agencia: document.getElementById('nome_agencia').value,
            nome_gestor: document.getElementById('nome_gestor').value,
            cep: document.getElementById('cep').value.replace(/\D/g, ''),
            numero: parseInt(document.getElementById('numero').value),
            data_inauguracao: document.getElementById('data_inauguracao').value
        };

        try {
            const response = await fetch(`${BASE_URL}/agencias`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa('admin:admin')
                },
                body: JSON.stringify(agencia)
            });

            if (response.ok) {
                const novaAgencia = await response.json();
                showAlert(`Ag√™ncia ${novaAgencia.cgc} cadastrada com sucesso!`);
                document.getElementById('agenciaForm').reset();
                document.getElementById('logradouro_display').value = '';
                document.getElementById('cidade_display').value = '';
                document.getElementById('estado_display').value = '';
                loadAgencias();
            } else {
                const error = await response.text();
                showAlert(`Erro: ${error}`, 'danger');
            }
        } catch (error) {
            showAlert('Erro de conex√£o com a API', 'danger');
        }
    }

    // Excluir ag√™ncia
    async function deleteAgencia(cgc) {
        if (!confirm(`Tem certeza que deseja excluir a ag√™ncia ${cgc}?`)) return;

        try {
            const response = await fetch(`${BASE_URL}/agencias/${cgc}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Basic ' + btoa('admin:admin')
                }
            });

            if (response.ok) {
                showAlert(`Ag√™ncia ${cgc} exclu√≠da com sucesso!`);
                loadAgencias();
            } else {
                showAlert('Erro ao excluir ag√™ncia', 'danger');
            }
        } catch (error) {
            showAlert('Erro de conex√£o com a API', 'danger');
        }
    }

    // Mostrar/ocultar loading
    function showLoading(show) {
        const tbody = document.getElementById('agenciasTableBody');
        if (show) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        Carregando ag√™ncias...
                    </td>
                </tr>
            `;
        }
    }
</script>
</body>
</html>